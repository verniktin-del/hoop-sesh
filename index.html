<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <title>Rezervacija termina</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1D428A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hoops">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="icon" href="assets/icon-192.png">

  <!-- Firebase SDKs - Compat version for compatibility -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

  <style>
    :root{
      --brand:#1D428A;
      --accent:#FFC72C;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f8fafc;
      --success:#10b981;
      --warning:#f59e0b;
      --error:#ef4444;
      --border:#e2e8f0;
      --shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background:var(--bg);
      color:#1f2937;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.6;
    }

    /* Centered login */
    #loginWrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:var(--gradient);
    }
    #loginBox{
      width:420px;
      max-width:95%;
      background:var(--card);
      border-radius:20px;
      padding:40px;
      box-shadow:var(--shadow-lg);
      text-align:center;
      border:1px solid var(--border);
      backdrop-filter:blur(10px);
    }
    #loginBox h1{
      margin:0 0 8px;
      font-size:28px;
      color:var(--brand);
      font-weight:700;
      background:var(--gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    #loginBox p{
      margin:0 0 32px;
      color:var(--muted);
      font-size:16px;
    }

    #googleLoginBtn{
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:16px 24px;
      background:var(--brand);
      color:white;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:16px;
      transition:all 0.3s ease;
      box-shadow:var(--shadow);
    }
    #googleLoginBtn:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
      background:#1a3a7a;
    }
    #googleLoginBtn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }
    #googleLoginBtn img{width:20px;height:20px}

    /* App layout */
    #app{
      display:none;
      max-width:100vw;
      margin:0 auto;
      padding:0;
      min-height:100vh;
      background:var(--bg);
      width:100%;
      overflow-x:hidden;
    }
    header.appHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 20px;
      background:var(--card);
      border-bottom:1px solid var(--border);
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:100;
      width:100%;
      box-sizing:border-box;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand h2{
      margin:0;
      color:var(--brand);
      font-size:24px;
      font-weight:700;
      background:var(--gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .userBar{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .profileBtn{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--bg);
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:20px;
      cursor:pointer;
      font-weight:500;
      transition:all 0.3s ease;
    }
    .profileBtn:hover{
      background:var(--border);
      transform:translateY(-1px);
    }
    .profileAvatar{
      width:32px;
      height:32px;
      border-radius:50%;
      background:var(--gradient);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:700;
      font-size:14px;
    }
    .logoutBtn{
      background:var(--error);
      color:white;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.3s ease;
    }
    .logoutBtn:hover{
      background:#dc2626;
      transform:translateY(-1px);
    }

    /* Main content */
    .main{
      display:flex;
      gap:16px;
      align-items:flex-start;
      padding:0 20px 20px 20px;
      width:100%;
      box-sizing:border-box;
      flex-wrap:wrap;
    }
    .calendarCard{
      background:var(--card);
      border-radius:16px;
      padding:20px;
      flex: 1 1 100%;
      min-width:0;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      width:100%;
      box-sizing:border-box;
    }
    .controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .monthNav{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .navBtn{
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#efefef;
      font-size:14px;
      white-space:nowrap;
    }
    .monthTitle{
      font-weight:700;
      color:#0b1220;
      font-size:16px;
      white-space:nowrap;
    }

    .weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:2px;
      margin-top:12px;
    }
    .weekday{
      text-align:center;
      padding:8px 2px;
      font-weight:700;
      color:var(--muted);
      font-size:12px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:2px;
      margin-top:8px;
    }
    .day{
      min-height:60px;
      border-radius:6px;
      border:1px solid #e6e9ef;
      background:white;
      display:flex;
      flex-direction:column;
      padding:4px;
      justify-content:flex-start;
      gap:4px;
      position:relative;
      cursor:pointer;
      font-size:12px;
    }
    .day.empty{background:transparent;border:none;cursor:default}
    .day .num{
      font-weight:700;
      font-size:14px;
    }
    .day .items{
      font-size:10px;
      color:#222;
      display:flex;
      flex-direction:column;
      gap:2px;
      overflow:hidden;
    }
    .badge{
      display:inline-block;
      padding:2px 4px;
      border-radius:4px;
      font-size:10px;
    }

    .available{background:linear-gradient(90deg,#e9eefb,#f7f9ff)}
    .mine{background:#e6fbff;border:2px solid #6BCBFF}
    .reserved-other{background:linear-gradient(90deg,#fff4e0,#fff8f0)}
    .past{opacity:0.5;pointer-events:none}


    /* right panel - form */
    .formCard{
      background:var(--card);
      border-radius:12px;
      padding:20px;
      width:100%;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      flex:1 1 100%;
      box-sizing:border-box;
      margin-top:16px;
    }
    .formCard h3{margin-top:0}
    .formRow{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    input[type="time"],select,textarea{
      padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;width:100%;
    }
    .primaryBtn{background:var(--brand);color:var(--accent);border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:700}
    .secondary{
      background:var(--bg);
      border:1px solid var(--border);
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:500;
      transition:all 0.3s ease;
    }

    .small{font-size:13px;color:var(--muted)}

    /* Leaderboard styles */
    .leaderboard-container{
      width:100%;
      overflow-x:auto;
      margin-top:16px;
      border-radius:8px;
      border:1px solid var(--border);
    }
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      background:var(--card);
      min-width:300px;
    }
    .leaderboard-table th{
      background:var(--brand);
      color:white;
      padding:12px 8px;
      text-align:left;
      font-weight:600;
      font-size:14px;
      border-bottom:2px solid var(--accent);
    }
    .leaderboard-table th.center{
      text-align:center;
    }
    .leaderboard-table td{
      padding:12px 8px;
      border-bottom:1px solid var(--border);
      font-size:14px;
      vertical-align:middle;
    }
    .leaderboard-table tr:hover{
      background:var(--bg);
    }
    .leaderboard-table .center{
      text-align:center;
    }
    .profile-link{
      color:var(--brand);
      text-decoration:none;
      font-weight:600;
      transition:color 0.3s ease;
    }
    .profile-link:hover{
      color:var(--accent);
      text-decoration:underline;
    }

    /* tooltip pre wrapping */
    .tooltip{
      white-space:pre-line;
      font-size:13px;
      color:#fff;
      background:#222;
      padding:6px 8px;border-radius:6px;
    }

    /* Leaderboard specific tweaks (reuses formCard for consistent look) */
    .leaderboardCard{
      margin-top:18px;
      padding:12px;
    }
    .center { text-align:center }

    /* Modal styles */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:1500;
    }
    .modal{background:#fff;border-radius:12px;padding:20px;max-width:900px;width:95%;max-height:85vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,0.25);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .closeBtn{background:#eee;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}

    /* Profile modal specific */
    .profile-avatar-large{
      width:80px;
      height:80px;
      border-radius:50%;
      background:var(--gradient);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:700;
      font-size:32px;
      margin:0 auto 16px;
    }
    .profile-stats{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
      margin:20px 0;
    }
    .stat-box{
      background:var(--bg);
      padding:16px;
      border-radius:8px;
      text-align:center;
    }
    .stat-value{
      font-size:24px;
      font-weight:700;
      color:var(--brand);
    }
    .stat-label{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    /* Offline indicator */
    .offline-indicator{
      position:fixed;
      top:0;
      left:0;
      right:0;
      background:#ff6b6b;
      color:white;
      text-align:center;
      padding:8px;
      font-size:14px;
      z-index:9999;
      display:none;
    }

    /* PWA Install button */
    .install-btn{
      background:var(--accent);
      color:var(--brand);
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      display:none;
    }
    .install-btn:hover{
      background:#e6b800;
    }

    /* Tab navigation */
    .tab-nav{
      display:flex;
      gap:4px;
      margin:16px 20px;
      background:var(--card);
      padding:8px;
      border-radius:12px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      width:calc(100% - 40px);
      box-sizing:border-box;
    }
    .tab-btn{
      padding:12px 20px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:600;
      color:var(--muted);
      border-radius:8px;
      transition:all 0.3s ease;
      position:relative;
      flex:1;
    }
    .tab-btn.active{
      color:var(--brand);
      background:var(--bg);
      box-shadow:var(--shadow);
    }
    .tab-btn:hover:not(.active){
      background:var(--bg);
      color:var(--brand);
    }
    .tab-content{
      display:none;
    }
    .tab-content.active{
      display:block;
    }

    /* Notification animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Update banner */
    .update-banner{
      position:fixed;
      top:0;
      left:0;
      right:0;
      background:var(--gradient);
      color:white;
      padding:12px 16px;
      text-align:center;
      z-index:10000;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      display:none;
      align-items:center;
      justify-content:center;
      gap:12px;
      font-weight:600;
      font-size:14px;
    }
    .update-banner button{
      background:rgba(255,255,255,0.2);
      border:1px solid rgba(255,255,255,0.3);
      color:white;
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
    }

    /* Mobile responsive design */
    @media (max-width:768px){
      .main{
        flex-direction:column;
        padding:0 16px 16px 16px;
        gap:12px;
      }
      .calendarCard{
        padding:16px;
      }
      .formCard{
        margin-top:0;
        padding:16px;
      }
      .tab-nav{
        margin:12px 16px;
        width:calc(100% - 32px);
      }
      .tab-btn{
        padding:10px 16px;
        font-size:14px;
      }
      .controls{
        flex-direction:column;
        align-items:stretch;
        gap:12px;
      }
      .monthNav{
        justify-content:center;
      }
      .navBtn{
        flex:1;
        text-align:center;
      }
      .day{
        min-height:50px;
        padding:3px;
      }
      .day .num{
        font-size:12px;
      }
      .day .items{
        font-size:9px;
      }
      .userBar{
        flex-direction:column;
        gap:8px;
        align-items:stretch;
      }
      .modal{
        width:95%;
        margin:10px;
      }
      header.appHeader{
        padding:12px 16px;
        flex-wrap:wrap;
      }
      .brand h2{
        font-size:20px;
      }
      .leaderboard-container{
        margin-top:12px;
      }
      .leaderboard-table th{
        padding:10px 6px;
        font-size:12px;
      }
      .leaderboard-table td{
        padding:10px 6px;
        font-size:12px;
      }
      .profile-stats{
        grid-template-columns:1fr;
        gap:12px;
      }
    }

    @media (max-width:480px){
      .day{
        min-height:45px;
        font-size:10px;
      }
      .day .num{
        font-size:11px;
      }
      .day .items{
        font-size:8px;
      }
      .weekday{
        font-size:10px;
        padding:6px 1px;
      }
      .navBtn{
        padding:6px 8px;
        font-size:12px;
      }
      .monthTitle{
        font-size:14px;
      }
      .leaderboard-table th{
        padding:8px 4px;
        font-size:11px;
      }
      .leaderboard-table td{
        padding:8px 4px;
        font-size:11px;
      }
      .leaderboard-table{
        min-width:280px;
      }
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginWrapper">
    <div id="loginBox" role="dialog" aria-labelledby="loginTitle">
      <h1 id="loginTitle">Prijava</h1>
      <p>Prijavite se putem Google raƒçuna da biste rezervirali teren.</p>
      <button id="googleLoginBtn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" />
        Prijavi se s Googleom
      </button>
      <div id="loginLoading" style="display: none; margin-top: 16px; color: var(--muted);">
        Provjeravam prijavu...
      </div>
    </div>
  </div>

  <!-- Offline indicator -->
  <div id="offlineIndicator" class="offline-indicator">
    Nema internetske veze - radite offline
  </div>

  <!-- APP -->
  <div id="app">
    <header class="appHeader">
      <div class="brand">
        <h2>Rezervacije</h2>
        <div class="small">Upravljanje terminima</div>
      </div>

      <div class="userBar">
        <button id="profileBtn" class="profileBtn">
          <div class="profileAvatar">U</div>
          <span class="profileName">User</span>
        </button>
        <button id="installBtn" class="install-btn">üì± Instaliraj App</button>
        <button id="logoutBtn" class="logoutBtn">Odjava</button>
      </div>
    </header>

    <main class="main">
      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="calendar">üìÖ Kalendar</button>
        <button class="tab-btn" data-tab="leaderboard">üèÜ Leaderboard</button>
        <button class="tab-btn" data-tab="notifications">üîî Obavje≈°tenja</button>
      </div>

      <!-- Calendar Tab -->
      <div id="calendarTab" class="tab-content active">
        <div class="main">
      <section class="calendarCard" aria-label="Kalendar">
        <div class="controls">
          <div class="monthNav">
            <button id="prevMonth" class="navBtn">&lt; Prethodni</button>
            <div class="monthTitle" id="monthTitle">Rujan 2025</div>
            <button id="nextMonth" class="navBtn">Sljedeƒái &gt;</button>
          </div>
          <div class="small">Kliknite dan za rezervaciju ili pregled</div>
        </div>

        <div class="weekdays" id="weekdays"></div>
        <div class="grid" id="daysGrid" role="grid"></div>
      </section>

      <aside class="formCard" aria-label="Forma za rezervaciju">
        <h3>Rezerviraj termin</h3>
        <div class="small">Odabrani datum: <span id="selectedDateText">‚Äî</span></div>

        <form id="reservationForm">
          <div class="formRow">
            <label class="small">Vrijeme</label>
            <input type="time" id="timeInput" required />
          </div>

          <div class="formRow">
            <label class="small">Teren</label>
            <select id="terenSelect" required>
              <option value="">Odaberite teren</option>
              <option>Jadran</option>
              <option>Contadina</option>
              <option>Secrete</option>
              <option>Maj</option>
            </select>
          </div>

          <div style="display:flex;gap:8px">
            <button type="submit" class="primaryBtn">Rezerviraj</button>
            <button type="button" id="cancelBtn" class="secondary">Odustani</button>
          </div>

          <div style="margin-top:12px" id="formMsg" class="small"></div>
        </form>
      </aside>
        </div>
      </div>

      <!-- Leaderboard Tab -->
      <div id="leaderboardTab" class="tab-content">
        <section class="calendarCard" aria-label="Leaderboard">
          <h3>üèÜ Leaderboard</h3>
      <div id="leaderboardLoading" class="small">Uƒçitavanje...</div>

          <div class="leaderboard-container">
            <table id="leaderboardTable" class="leaderboard-table" style="display:none;">
        <thead>
          <tr>
            <th>Name</th>
            <th class="center">Wins</th>
            <th class="center">Losses</th>
                  <th class="center">Diff</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
          </div>

      <div id="leaderboardEmpty" class="small" style="display:none">Nema odigranih igara za prikaz.</div>
      <div style="margin-top:8px;" class="small">Scores are aggregated from logged 1v1 games.</div>
    </section>
      </div>

      <!-- Notifications Tab -->
      <div id="notificationsTab" class="tab-content">
        <section class="calendarCard" aria-label="Notifications">
          <h3>üîî Obavje≈°tenja</h3>
          <div id="notificationsLoading" class="small">Uƒçitavanje...</div>
          <div id="notificationsList" style="display:none;"></div>
          <div id="notificationsEmpty" class="small" style="display:none;">Nema obavje≈°tenja.</div>
        </section>
      </div>

    </main>
  </div>

  <!-- Modal backdrop for profile -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle">Profil igraƒça</h2>
        <div>
          <button id="modalClose" class="closeBtn">Zatvori</button>
        </div>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

<script>
  console.log('Script starting...');
  
  // ---------- FIREBASE CONFIG AND INITIALIZATION ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let messaging = null;

  // Initialize messaging if supported
  try {
    messaging = firebase.messaging();
    console.log('Firebase Messaging initialized');
  } catch (error) {
    console.warn('Firebase Messaging not supported:', error);
  }

  // Set authentication persistence to LOCAL (stays logged in after browser restart)
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => {
      console.log('Auth persistence set to LOCAL - users will stay logged in');
    })
    .catch((error) => {
      console.error('Error setting auth persistence:', error);
    });

  // ---------- DOM ELEMENT REFERENCES ----------
  const loginWrapper = document.getElementById("loginWrapper");
  const loginBox = document.getElementById("loginBox");
  const googleLoginBtn = document.getElementById("googleLoginBtn");
  const loginLoading = document.getElementById("loginLoading");

  const appRoot = document.getElementById("app");
  const profileBtn = document.getElementById("profileBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const installBtn = document.getElementById("installBtn");

  const weekdaysContainer = document.getElementById("weekdays");
  const daysGrid = document.getElementById("daysGrid");
  const monthTitle = document.getElementById("monthTitle");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");

  const reservationForm = document.getElementById("reservationForm");
  const timeInput = document.getElementById("timeInput");
  const terenSelect = document.getElementById("terenSelect");
  const selectedDateText = document.getElementById("selectedDateText");
  const cancelBtn = document.getElementById("cancelBtn");
  const formMsg = document.getElementById("formMsg");

  const leaderboardLoading = document.getElementById("leaderboardLoading");
  const leaderboardTable = document.getElementById("leaderboardTable");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const leaderboardEmpty = document.getElementById("leaderboardEmpty");

  const notificationsLoading = document.getElementById("notificationsLoading");
  const notificationsList = document.getElementById("notificationsList");
  const notificationsEmpty = document.getElementById("notificationsEmpty");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalContent = document.getElementById("modalContent");
  const modalClose = document.getElementById("modalClose");

  const offlineIndicator = document.getElementById('offlineIndicator');

  // ---------- STATE VARIABLES ----------
  let currentUser = null;
  let visibleYear = (new Date()).getFullYear();
  let visibleMonth = (new Date()).getMonth(); // 0-based
  let selectedDay = null; // Date object (year,month,day)
  let reservationsCache = []; // cached reservation documents
  let isOnline = navigator.onLine;
  let fcmToken = null;

  // Snapshot unsubscribe holders
  let leaderboardUnsub = null;
  let profileUnsub1 = null;
  let profileUnsub2 = null;
  let notificationsUnsub = null;
  let gamesUnsub = null;

  // PWA install prompt
  let deferredPrompt;

  // Notification permission
  let notificationPermission = Notification.permission;

  const WEEKDAYS = ["Pon","Uto","Sri","ƒået","Pet","Sub","Ned"]; 

  // ---------- UTILITY FUNCTIONS ----------
  function slugify(s) {
    return (s || '').toString().trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g,'');
  }

  function monthYearTitle(year, month) {
    return new Date(year, month, 1).toLocaleString('hr-HR', { month: 'long', year: 'numeric' });
  }

  function startOfMonthWeekday(year, month) {
    // return 0..6 where 0 = Monday (we want Monday first)
    const jsDay = new Date(year, month, 1).getDay(); // 0 Sunday .. 6 Saturday
    // convert so Monday=0..Sunday=6
    return (jsDay === 0) ? 6 : jsDay - 1;
  }

  function formatLocalDate(y,m,d){
    return `${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}`;
  }

  // ---------- FCM TOKEN MANAGEMENT ----------
  async function initializeFCM() {
    if (!messaging) {
      console.log('Messaging not supported');
      return;
    }

    try {
      // Request notification permission
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        console.log('Notification permission granted');
        
        // Get FCM token
        fcmToken = await messaging.getToken({
          vapidKey: 'BEl62iUYgUivxIkv69yViEuiBIa-IHI9H-1kQj0azJmrS1ifDZxUl8QaYpu1X0VjU8jT3V8EoWUzr1'
        });
        
        if (fcmToken) {
          console.log('FCM Token:', fcmToken);
          // Store token in user's document for sending notifications
          if (currentUser) {
            await updateUserFCMToken(fcmToken);
          }
        } else {
          console.log('No registration token available');
        }
      } else {
        console.log('Notification permission denied');
      }
    } catch (error) {
      console.error('Error initializing FCM:', error);
    }
  }

  // Update user's FCM token in Firestore
  async function updateUserFCMToken(token) {
    if (!currentUser) return;
    
    try {
      const userRef = db.collection('users').doc(currentUser.uid);
      await userRef.update({
        fcmToken: token,
        lastTokenUpdate: firebase.firestore.Timestamp.now()
      });
      console.log('FCM token updated for user');
    } catch (error) {
      console.error('Error updating FCM token:', error);
    }
  }

  // Listen for foreground messages
  if (messaging) {
    messaging.onMessage((payload) => {
      console.log('Message received in foreground:', payload);
      
      // Show notification in app
      const notification = payload.notification;
      if (notification) {
        // Create in-app notification
        showInAppNotification(notification.title, notification.body, payload.data);
      }
    });
  }

  // Show in-app notification
  function showInAppNotification(title, body, data) {
    const notificationEl = document.createElement('div');
    notificationEl.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      max-width: 300px;
      animation: slideIn 0.3s ease-out;
    `;
    
    notificationEl.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 8px;">${title}</div>
      <div style="color: var(--muted); margin-bottom: 12px;">${body}</div>
      <button onclick="this.parentElement.remove()" style="
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--muted);
      ">√ó</button>
    `;
    
    document.body.appendChild(notificationEl);
    
    // Auto remove after 10 seconds
    setTimeout(() => {
      if (notificationEl.parentElement) {
        notificationEl.remove();
      }
    }, 10000);
  }

  // Handle join request responses from push notifications
  async function respondToJoinRequest(reservationId, response) {
    if (!currentUser) return;
    
    try {
      // Create a join request document
      const joinRequestData = {
        reservationId: reservationId,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        userName: currentUser.displayName || currentUser.email,
        response: response,
        timestamp: firebase.firestore.Timestamp.now()
      };
      
      await db.collection('joinRequests').add(joinRequestData);
      console.log('Join request response recorded:', response);
      
      // Show confirmation
      if (response === 'yes') {
        alert('Potvrƒëeno: Dolazim na rezervaciju!');
      } else {
        alert('Potvrƒëeno: Ne dolazim na rezervaciju.');
      }
      
    } catch (error) {
      console.error('Error responding to join request:', error);
      alert('Gre≈°ka pri slanju odgovora. Poku≈°ajte ponovno.');
    }
  }

  // Listen for messages from service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data.type === 'respondToJoinRequest') {
        respondToJoinRequest(event.data.reservationId, event.data.response);
      }
    });
  }

  // ---------- USERNAME MANAGEMENT ----------
  async function promptForUsername(defaultName) {
    return new Promise((resolve) => {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      `;
      
      modalContent.innerHTML = `
        <h3 style="margin: 0 0 16px; color: var(--brand);">Odaberite ime</h3>
        <p style="margin: 0 0 20px; color: var(--muted);">Kako se ≈æelite prikazivati u leaderboardu?</p>
        <input type="text" id="usernameInput" value="${defaultName}" style="
          width: 100%;
          padding: 12px;
          border: 2px solid var(--border);
          border-radius: 8px;
          font-size: 16px;
          margin-bottom: 20px;
          text-align: center;
        " placeholder="Unesite va≈°e ime">
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button id="confirmUsername" style="
            background: var(--brand);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
          ">Potvrdi</button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      const input = modalContent.querySelector('#usernameInput');
      const confirmBtn = modalContent.querySelector('#confirmUsername');
      
      input.focus();
      input.select();
      
      const handleConfirm = () => {
        const username = input.value.trim();
        if (username) {
          document.body.removeChild(modal);
          resolve(username);
        }
      };
      
      confirmBtn.addEventListener('click', handleConfirm);
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleConfirm();
        }
      });
    });
  }

  async function ensureUserInFirestore(user) {
    if (!user) return;
    const userRef = db.collection('users').doc(user.uid);
    const snapshot = await userRef.get();

    // Always ask for username on first login or if not set
    const savedName = localStorage.getItem('hoops_displayName');
    let chosenName = savedName;

    if (!snapshot.exists || !savedName) {
      // Show a better username prompt
      chosenName = await promptForUsername(user.displayName || user.email || "");
      if (!chosenName) chosenName = user.displayName || user.email || "Unnamed";
      
      // save locally so we don't ask again on this device
      try { localStorage.setItem('hoops_displayName', chosenName); } catch(e) { /* ignore */ }

      const key = slugify(chosenName);
      await userRef.set({
        uid: user.uid,
        email: user.email,
        name: key, // keep key in `name` for backward compatibility
        displayName: chosenName,
        key,
        wins: 0,
        losses: 0,
        pointsFor: 0,
        pointsAgainst: 0,
        createdAt: firebase.firestore.Timestamp.now(),
        fcmToken: null, // Will be set when FCM initializes
        lastLogin: firebase.firestore.Timestamp.now()
      });
    } else {
      // Update last login time
      await userRef.update({
        lastLogin: firebase.firestore.Timestamp.now()
      });
      
      // Ensure displayName saved locally for future logins on this device
      const data = snapshot.data();
      if (data && data.displayName && !savedName) {
        try { localStorage.setItem('hoops_displayName', data.displayName); } catch(e){};
      }
    }
  }

  // ---------- AUTHENTICATION FLOW ----------
  console.log('Setting up login button handler...');
  
  // Google login button click handler
  googleLoginBtn.addEventListener("click", async () => {
    console.log("Login button clicked!");
    try {
      googleLoginBtn.disabled = true;
      googleLoginBtn.textContent = 'Prijava u tijeku...';
      console.log("Creating Google auth provider...");
      
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('email');
      provider.addScope('profile');
      
      console.log("Attempting sign in with popup...");
      const result = await auth.signInWithPopup(provider);
      console.log("Sign in successful!", result.user.email);
    } catch (err) {
      console.error("Login error:", err);
      googleLoginBtn.disabled = false;
      googleLoginBtn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" />Prijavi se s Googleom';
      
      if (err.code === 'auth/popup-closed-by-user') {
        console.log("User closed the login popup");
      } else if (err.code === 'auth/cancelled-popup-request') {
        console.log("Popup request was cancelled");
      } else {
        alert("Prijava nije uspjela: " + (err.message || err));
      }
    }
  });

  // Logout button handler
  logoutBtn.addEventListener("click", async () => {
    console.log("Logout button clicked");
    try {
      await auth.signOut();
      console.log("User signed out successfully");
    } catch (error) {
      console.error("Error signing out:", error);
    }
  });

  // Show loading state while checking auth
  loginLoading.style.display = 'block';
  console.log("Checking auth state...");

  // Authentication state observer
  auth.onAuthStateChanged(async (user) => {
    console.log("Auth state changed:", user ? `User logged in: ${user.email}` : "No user logged in");
    
    if (user) {
      console.log("User details:", {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName
      });
      
      currentUser = user;
      loginWrapper.style.display = "none";
      appRoot.style.display = "block";
      loginLoading.style.display = "none";

      // Update profile button with user info
      updateProfileButton();

      try {
        console.log("Ensuring user in Firestore...");
        await ensureUserInFirestore(user);
        
        console.log("Initializing FCM...");
        await initializeFCM();
        
        console.log("Starting games listener...");
        startGamesListener();
        
        console.log("Loading reservations...");
        await loadReservations();
        
        console.log("Rendering calendar...");
        renderCalendar();
        
        console.log("App initialization complete!");
      } catch (error) {
        console.error("Error during post-login setup:", error);
      }
    } else {
      console.log("User logged out, showing login screen");
      currentUser = null;
      loginWrapper.style.display = "flex";
      appRoot.style.display = "none";
      loginLoading.style.display = "none";
      googleLoginBtn.disabled = false;
      googleLoginBtn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" />Prijavi se s Googleom';
      
      // Cleanup any subscriptions
      if (leaderboardUnsub) { leaderboardUnsub(); leaderboardUnsub = null; }
      if (notificationsUnsub) { notificationsUnsub(); notificationsUnsub = null; }
      if (gamesUnsub) { gamesUnsub(); gamesUnsub = null; }
    }
  });

  // Update profile button with user info
  function updateProfileButton() {
    if (!currentUser) return;
    
    const displayName = localStorage.getItem('hoops_displayName') || 
                       currentUser.displayName || 
                       currentUser.email || 
                       'User';
    
    const initials = displayName.split(' ')
      .map(n => n[0])
      .join('')
      .substring(0, 2)
      .toUpperCase();
    
    const avatar = profileBtn.querySelector('.profileAvatar');
    avatar.textContent = initials;
    
    const nameSpan = profileBtn.querySelector('.profileName');
    nameSpan.textContent = displayName.split(' ')[0];
  }

  // Open own profile
  profileBtn.addEventListener('click', async () => {
    if (!currentUser) return;
    
    const userRef = db.collection('users').doc(currentUser.uid);
    const userDoc = await userRef.get();
    
    if (userDoc.exists) {
      const userData = userDoc.data();
      openProfileModal(userData.key, true);
    }
  });

  // ---------- CALENDAR FUNCTIONS ----------
  async function loadReservations(){
    // load all reservations into cache
    reservationsCache = [];
    try {
      if (!isOnline) {
        console.log('Offline mode - using cached data');
        return;
      }
      
      const snapshot = await db.collection('reservations').get();
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        // keep id and timestamp if exists
        reservationsCache.push({ id: docSnap.id, ...data });
      });
      console.log(`Loaded ${reservationsCache.length} reservations`);
    } catch(err){
      console.error("Error loading reservations", err);
      // Show user-friendly error message
      if (formMsg) {
        if (err.code === 'permission-denied') {
          formMsg.textContent = "Nemate dozvole za pristup rezervacijama. Kontaktirajte administratora.";
        } else {
          formMsg.textContent = "Gre≈°ka pri uƒçitavanju rezervacija. Provjerite internetsku vezu.";
        }
        formMsg.style.color = "#d32f2f";
      }
      reservationsCache = [];
    }
  }

  function reservationsForDay(year,month,day){
    return reservationsCache.filter(r => {
      if (!r.timestamp) return false;
      const dt = r.timestamp.toDate();
      return dt.getFullYear()===year && dt.getMonth()===month && dt.getDate()===day;
    });
  }

  function renderCalendar(){
    daysGrid.innerHTML = "";
    weekdaysContainer.innerHTML = "";

    // weekdays header
    WEEKDAYS.forEach(w => {
      const wEl = document.createElement("div");
      wEl.className = "weekday";
      wEl.textContent = w;
      weekdaysContainer.appendChild(wEl);
    });

    const year = visibleYear;
    const month = visibleMonth;
    monthTitle.textContent = monthYearTitle(year, month);

    const firstWeekday = startOfMonthWeekday(year, month); // 0..6 (Monday..Sunday)
    const lastDay = new Date(year, month+1, 0).getDate();

    // render empty slots before first day
    for (let i=0;i<firstWeekday;i++){
      const empty = document.createElement("div");
      empty.className = "day empty";
      daysGrid.appendChild(empty);
    }

    const today = new Date();
    for (let d=1; d<=lastDay; d++){
      const dayEl = document.createElement("div");
      dayEl.className = "day";
      const dayNum = document.createElement("div");
      dayNum.className = "num";
      dayNum.textContent = d;
      dayEl.appendChild(dayNum);

      // reservations for that day
      const dayRes = reservationsForDay(year, month, d);

      const items = document.createElement("div");
      items.className = "items";
      if (dayRes.length>0){
        dayRes.slice(0,3).forEach(r => {
          const dt = r.timestamp.toDate();
          const t = dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          const item = document.createElement("div");
          item.textContent = `${r.name} ‚Äî ${t} ‚Äî ${r.teren}`;
          items.appendChild(item);
        });
        if (dayRes.length>3){
          const more = document.createElement("div");
          more.textContent = `+${dayRes.length-3} vi≈°e...`;
          more.style.color = "#666"; more.style.fontSize="12px";
          items.appendChild(more);
        }
        dayEl.appendChild(items);
      }

      // tooltip with details
      if (dayRes.length>0){
        let info = "";
        dayRes.forEach(r => {
          const dt = r.timestamp.toDate();
          const t = dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          info += `${r.name} ‚Äî ${t} ‚Äî ${r.teren}\n`;
        });
        dayEl.setAttribute("data-tooltip", info.trim());
        // show tooltip on hover via custom element
        dayEl.addEventListener("mouseenter", (e)=>{
          const tt = document.createElement("div");
          tt.className="tooltip";
          tt.id = "tmpTooltip";
          tt.textContent = e.currentTarget.getAttribute("data-tooltip");
          document.body.appendChild(tt);
          const rect = e.currentTarget.getBoundingClientRect();
          tt.style.position="absolute";
          tt.style.left = (rect.left + rect.width/2 - tt.offsetWidth/2) + "px";
          tt.style.top = (rect.top - tt.offsetHeight - 10) + "px";
        });
        dayEl.addEventListener("mouseleave", ()=>{
          const ttd = document.getElementById("tmpTooltip");
          if (ttd) ttd.remove();
        });
      }

      // status classes
      const slotDate = new Date(year, month, d);
      const slotIsPast = new Date(today.getFullYear(), today.getMonth(), today.getDate()) > slotDate;
      if (slotIsPast) dayEl.classList.add("past");
      else if (dayRes.length===0) dayEl.classList.add("available");
      else {
        // if any reservation belongs to current user, mark mine
        const mine = dayRes.find(r => r.user === (currentUser && currentUser.email));
        if (mine) dayEl.classList.add("mine");
        else dayEl.classList.add("reserved-other");
      }

      // click behavior
      dayEl.addEventListener("click", () => {
        if (slotIsPast) return;
        selectedDay = new Date(year, month, d);
        selectedDateText.textContent = formatLocalDate(year,month,d);
        reservationForm.style.display = "block";
      });

      daysGrid.appendChild(dayEl);
    }
  }

  // prev / next handlers
  prevMonthBtn.addEventListener("click", () => {
    visibleMonth--;
    if (visibleMonth < 0){ visibleMonth = 11; visibleYear--; }
    renderCalendar();
  });
  nextMonthBtn.addEventListener("click", () => {
    visibleMonth++;
    if (visibleMonth > 11){ visibleMonth = 0; visibleYear++; }
    renderCalendar();
  });

  // ---------- RESERVATION FORM SUBMIT ----------
  reservationForm.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!selectedDay) { formMsg.textContent = "Odaberite datum iz kalendara."; return; }
    if (!currentUser) { formMsg.textContent = "Morate biti prijavljeni."; return; }

    // Use stored displayName or currentUser.displayName or email
    const name = localStorage.getItem('hoops_displayName') || currentUser.displayName || currentUser.email || 'Unnamed';
    const timeVal = timeInput.value;
    const teren = terenSelect.value;

    if (!timeVal || !teren){ formMsg.textContent = "Ispunite sva polja."; return; }
    formMsg.textContent = "Spremanje‚Ä¶";

    // combine selectedDay + timeVal into Date
    const [hh,mm] = timeVal.split(":").map(s => parseInt(s,10));
    const dt = new Date(selectedDay.getFullYear(), selectedDay.getMonth(), selectedDay.getDate(), hh, mm);

    // Prevent double booking at same timestamp for same teren (simple check)
    const clash = reservationsCache.find(r => {
      if (!r.timestamp) return false;
      const rdt = r.timestamp.toDate();
      return Math.abs(rdt.getTime() - dt.getTime()) < (1000*60*60) && r.teren === teren; // 1h window
    });
    if (clash){
      formMsg.textContent = "Postoji rezervacija u istom terminu za odabrani teren.";
      return;
    }

    try {
      const reservationData = {
        timestamp: firebase.firestore.Timestamp.fromDate(dt),
        name,
        teren,
        user: currentUser.email,
        createdAt: firebase.firestore.Timestamp.now()
      };

      const docRef = await db.collection('reservations').add(reservationData);
      console.log("Reservation created with ID:", docRef.id);

      formMsg.textContent = "Rezervirano uspje≈°no!";
      formMsg.style.color = "#10b981";
      reservationForm.reset();
      selectedDateText.textContent = "‚Äî";
      selectedDay = null;

      // Send notification to all users about new reservation
      const dateStr = formatLocalDate(dt.getFullYear(), dt.getMonth(), dt.getDate());
      const timeStr = dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      await notifyAllUsers(`${name} je rezervirao teren ${teren} za ${dateStr} u ${timeStr}`, docRef.id);

      // refresh cache & calendar
      await loadReservations();
      renderCalendar();

    } catch(err){
      console.error("Add reservation error", err);
      if (err.code === 'permission-denied') {
        formMsg.textContent = "Nemate dozvole za kreiranje rezervacija. Kontaktirajte administratora.";
      } else if (err.code === 'unavailable') {
        formMsg.textContent = "Servis trenutno nije dostupan. Poku≈°ajte ponovno.";
      } else {
        formMsg.textContent = "Gre≈°ka pri spremanju. Poku≈°ajte ponovno.";
      }
      formMsg.style.color = "#d32f2f";
    }
  });

  cancelBtn.addEventListener("click", () => {
    reservationForm.reset();
    selectedDateText.textContent = "‚Äî";
    selectedDay = null;
    formMsg.textContent = "";
    reservationForm.style.display = "none";
  });

  // Notify all users function
  async function notifyAllUsers(message, reservationId) {
    try {
      // Create notification document in Firestore for tracking responses
      const notificationData = {
        message: message,
        reservationId: reservationId,
        createdAt: firebase.firestore.Timestamp.now(),
        responses: {}, // Will store user responses: {userId: 'yes'/'no'}
        type: 'reservation'
      };
      
      await db.collection('notifications').add(notificationData);
      console.log('Notification created for all users');
      
      // Also show local notification
      if (Notification.permission === 'granted') {
        new Notification('Hoops', {
          body: message,
          icon: './assets/icon-192.png',
          badge: './assets/icon-192.png'
        });
      }
    } catch (error) {
      console.error('Error creating notification:', error);
    }
  }

  // ---------- TAB NAVIGATION ----------
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Remove active class from all tabs and content
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding content
      btn.classList.add('active');
      const tabId = btn.dataset.tab + 'Tab';
      document.getElementById(tabId).classList.add('active');
      
      // Load leaderboard data when leaderboard tab is opened
      if (btn.dataset.tab === 'leaderboard') {
        startLeaderboardRealtime();
      }
      // Load notifications when notifications tab is opened
      if (btn.dataset.tab === 'notifications') {
        startNotificationsRealtime();
      }
    });
  });

  // ---------- LEADERBOARD FUNCTIONALITY ----------
  function startLeaderboardRealtime() {
    // if already listening, detach first
    if (leaderboardUnsub) { leaderboardUnsub(); leaderboardUnsub = null; }

    try {
      const gamesRef = db.collection('games');

      // Listen to games collection
      leaderboardUnsub = gamesRef.onSnapshot(
        () => { computeAndRenderLeaderboard(); },
        (error) => {
          console.error('Leaderboard snapshot error:', error);
          // Fallback to one-time load if realtime fails
          computeAndRenderLeaderboard();
        }
      );

      // initial compute
      computeAndRenderLeaderboard();
    } catch (error) {
      console.error('Error starting leaderboard realtime:', error);
      // Fallback to one-time load
      computeAndRenderLeaderboard();
    }
  }

  async function computeAndRenderLeaderboard() {
    try {
      console.log('Computing leaderboard...');
      leaderboardLoading.style.display = '';
      leaderboardTable.style.display = 'none';
      leaderboardEmpty.style.display = 'none';
      leaderboardBody.innerHTML = '';

      // Start with fresh users map - don't pre-populate from users collection
      const usersMap = {};

      // fetch games snapshot and calculate stats from games only
      const gamesSnap = await db.collection('games').get();
      let gameCount = 0;
      
      gamesSnap.forEach(docSnap => {
        const g = docSnap.data();
        const t1Key = (g.team1 || g.team1Key || '').toString().toLowerCase();
        const t2Key = (g.team2 || g.team2Key || '').toString().toLowerCase();
          
        if (!t1Key || !t2Key) return;
        gameCount++;
          
        // Initialize players if they don't exist
        if (!usersMap[t1Key]) {
          usersMap[t1Key] = { 
            key: t1Key, 
            name: g.team1Display || t1Key, 
            wins: 0, 
            losses: 0, 
            pointsFor: 0, 
            pointsAgainst: 0 
          };
        }
        if (!usersMap[t2Key]) {
          usersMap[t2Key] = { 
            key: t2Key, 
            name: g.team2Display || t2Key, 
            wins: 0, 
            losses: 0, 
            pointsFor: 0, 
            pointsAgainst: 0 
          };
        }
          
        // Add points from this game
        usersMap[t1Key].pointsFor += (g.score1 || 0);
        usersMap[t1Key].pointsAgainst += (g.score2 || 0);
        usersMap[t2Key].pointsFor += (g.score2 || 0);
        usersMap[t2Key].pointsAgainst += (g.score1 || 0);
          
        // Add wins/losses
        if ((g.score1 || 0) > (g.score2 || 0)) { 
          usersMap[t1Key].wins += 1; 
          usersMap[t2Key].losses += 1; 
        } else if ((g.score2 || 0) > (g.score1 || 0)) { 
          usersMap[t2Key].wins += 1; 
          usersMap[t1Key].losses += 1; 
        }
      });

      leaderboardLoading.style.display = 'none';
        
      if (gameCount === 0) { 
        leaderboardEmpty.style.display = '';
        leaderboardEmpty.textContent = 'Nema odigranih igara za prikaz.';
        return; 
      }

      // Convert to array and sort by wins, then point difference
      const arr = Object.values(usersMap);
      arr.sort((a,b) => { 
        if ((b.wins||0) !== (a.wins||0)) return (b.wins||0)-(a.wins||0); 
        return ((b.pointsFor||0)-(b.pointsAgainst||0)) - ((a.pointsFor||0)-(a.pointsAgainst||0)); 
      });

      arr.forEach(u => {
        const tr = document.createElement('tr');
        const nameEl = document.createElement('a');
        nameEl.href = '#';
        nameEl.className = 'profile-link';
        nameEl.textContent = u.name;
        nameEl.addEventListener('click', (e) => { 
          e.preventDefault(); 
          openProfileModal(u.key, false); 
        });
        
        const tdName = document.createElement('td'); 
        tdName.appendChild(nameEl);
        const tdWins = document.createElement('td'); 
        tdWins.className = 'center'; 
        tdWins.textContent = u.wins||0;
        const tdLoss = document.createElement('td'); 
        tdLoss.className = 'center'; 
        tdLoss.textContent = u.losses||0;
        const tdDiff = document.createElement('td'); 
        tdDiff.className = 'center'; 
        tdDiff.textContent = (u.pointsFor||0)-(u.pointsAgainst||0);
        
        tr.appendChild(tdName); 
        tr.appendChild(tdWins); 
        tr.appendChild(tdLoss); 
        tr.appendChild(tdDiff);
        leaderboardBody.appendChild(tr);
      });

      leaderboardTable.style.display = 'table';
      console.log('Leaderboard rendered with', arr.length, 'players');
    } catch (error) {
      console.error('Error loading leaderboard:', error);
      leaderboardLoading.style.display = 'none';
      leaderboardEmpty.style.display = '';
      if (error.code === 'permission-denied') {
        leaderboardEmpty.textContent = 'Nemate dozvole za pristup leaderboardu. Kontaktirajte administratora.';
      } else {
        leaderboardEmpty.textContent = 'Gre≈°ka pri uƒçitavanju leaderboarda.';
      }
    }
  }

  // ---------- NOTIFICATIONS FUNCTIONALITY ----------
  function startNotificationsRealtime() {
    // if already listening, detach first
    if (notificationsUnsub) { notificationsUnsub(); notificationsUnsub = null; }

    try {
      notificationsUnsub = db.collection('notifications')
        .orderBy('createdAt', 'desc')
        .limit(20)
        .onSnapshot(
          (snapshot) => { renderNotifications(snapshot); },
          (error) => {
            console.error('Notifications snapshot error:', error);
            notificationsLoading.style.display = 'none';
            notificationsEmpty.style.display = '';
            notificationsEmpty.textContent = 'Gre≈°ka pri uƒçitavanju obavje≈°tenja.';
          }
        );
    } catch (error) {
      console.error('Error starting notifications realtime:', error);
      notificationsLoading.style.display = 'none';
      notificationsEmpty.style.display = '';
      notificationsEmpty.textContent = 'Gre≈°ka pri uƒçitavanju obavje≈°tenja.';
    }
  }

  function renderNotifications(snapshot) {
    notificationsLoading.style.display = 'none';
    notificationsList.style.display = 'none';
    notificationsEmpty.style.display = 'none';

    if (snapshot.empty) {
      notificationsEmpty.style.display = '';
      notificationsEmpty.textContent = 'Nema obavje≈°tenja.';
      return;
    }

    notificationsList.innerHTML = '';
    
    snapshot.forEach(doc => {
      const notification = doc.data();
      const notificationEl = document.createElement('div');
      notificationEl.style.cssText = `
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: var(--shadow);
      `;

      const date = notification.createdAt?.toDate ? 
        notification.createdAt.toDate() : 
        new Date(notification.createdAt?.seconds * 1000);
      
      const dateStr = date ? date.toLocaleString('hr-HR') : 'Nepoznato';

      notificationEl.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">${notification.message}</div>
            <div class="small" style="color: var(--muted);">${dateStr}</div>
          </div>
        </div>
      `;

      notificationsList.appendChild(notificationEl);
    });

    notificationsList.style.display = 'block';
  }

  // ---------- GAMES LISTENER FOR NOTIFICATIONS ----------
  function startGamesListener() {
    if (gamesUnsub) { gamesUnsub(); gamesUnsub = null; }
    
    try {
      const gamesRef = db.collection('games');
      
      gamesUnsub = gamesRef.orderBy('createdAt', 'desc').limit(1).onSnapshot((snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const game = change.doc.data();
            const gameId = change.doc.id;
            
            // Don't notify for the first load
            if (game.createdAt && game.createdAt.toDate) {
              const gameTime = game.createdAt.toDate();
              const now = new Date();
              const timeDiff = now.getTime() - gameTime.getTime();
              
              // Only notify if the game was created in the last 30 seconds
              if (timeDiff < 30000) {
                notifyNewGame(game, gameId);
              }
            }
          }
        });
      }, (error) => {
        console.error('Games listener error:', error);
      });
    } catch (error) {
      console.error('Error starting games listener:', error);
    }
  }

  // Notify about new game
  async function notifyNewGame(game, gameId) {
    try {
      const team1Display = game.team1Display || game.team1 || 'Player 1';
      const team2Display = game.team2Display || game.team2 || 'Player 2';
      const score1 = game.score1 || 0;
      const score2 = game.score2 || 0;
      
      const message = `Nova igra: ${team1Display} vs ${team2Display} (${score1}-${score2})`;
      
      // Create notification document
      const notificationData = {
        message: message,
        gameId: gameId,
        createdAt: firebase.firestore.Timestamp.now(),
        responses: {},
        type: 'game'
      };
      
      await db.collection('notifications').add(notificationData);
      console.log('Game notification created');
      
      // Show local notification
      if (Notification.permission === 'granted') {
        new Notification('Hoops', {
          body: message,
          icon: './assets/icon-192.png'
        });
      }
      
      // Show in-app notification
      showInAppNotification('Hoops', message);
      
    } catch (error) {
      console.error('Error creating game notification:', error);
    }
  }

  // ---------- PROFILE MODAL ----------
  function openProfileModal(userKey, isOwnProfile) {
    // cleanup any previous subs
    if (profileUnsub1) { profileUnsub1(); profileUnsub1 = null; }
    if (profileUnsub2) { profileUnsub2(); profileUnsub2 = null; }
    modalContent.innerHTML = '<div class="small">Uƒçitavanje...</div>'; 
    modalBackdrop.style.display = 'flex';

    // create elements
    const header = document.createElement('div'); 
    const avatarLarge = document.createElement('div');
    avatarLarge.className = 'profile-avatar-large';
    
    const nameH = document.createElement('h3');
    nameH.id = 'modalPlayerName';
    nameH.textContent = userKey;
    nameH.style.textAlign = 'center';
    nameH.style.margin = '0 0 8px';
    
    const statsRow = document.createElement('div'); 
    statsRow.className = 'profile-stats';
    statsRow.innerHTML = `
      <div class="stat-box">
        <div class="stat-value" id="modalWins">0</div>
        <div class="stat-label">Wins</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="modalLosses">0</div>
        <div class="stat-label">Losses</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="modalDiff">0</div>
        <div class="stat-label">Point Diff</div>
      </div>
    `;
    
    const gamesTitle = document.createElement('h4');
    gamesTitle.textContent = 'Recent Games';
    gamesTitle.style.margin = '20px 0 12px';
    
    const gamesContainer = document.createElement('div'); 
    gamesContainer.id = 'modalGames'; 
    gamesContainer.className = 'small'; 
    gamesContainer.textContent='Uƒçitavanje...';

    header.appendChild(avatarLarge);
    header.appendChild(nameH);
    
    modalContent.innerHTML = ''; 
    modalContent.appendChild(header); 
    modalContent.appendChild(statsRow); 
    modalContent.appendChild(gamesTitle);
    modalContent.appendChild(gamesContainer);

    // Try to lookup display name from users collection (one-time)
    (async ()=>{
      try{
        const usersRef = db.collection('users');
        const q = await usersRef.where('key','==', userKey).limit(1).get();
        if (!q.empty) {
          const u = q.docs[0].data();
          const displayName = u.displayName || u.name || userKey;
          nameH.textContent = displayName;
          
          const initials = displayName.split(' ')
            .map(n => n[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
          avatarLarge.textContent = initials;
        } else {
          const initials = userKey.substring(0, 2).toUpperCase();
          avatarLarge.textContent = initials;
        }
      } catch(e){ 
        console.warn('User lookup failed', e); 
        const initials = userKey.substring(0, 2).toUpperCase();
        avatarLarge.textContent = initials;
      }
    })();

    // real-time listen for games where team1==userKey or team2==userKey and merge results
    const gamesRef = db.collection('games');
    
    const gamesMap = new Map();

    function renderModalGames() {
      const arr = Array.from(gamesMap.values()).sort((a,b)=>{ 
        const da = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : (a.createdAt? new Date(a.createdAt).getTime():0); 
        const dbt = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : (b.createdAt? new Date(b.createdAt).getTime():0); 
        return dbt-da; 
      }).slice(0, 10);
      
      if (arr.length===0) { 
        gamesContainer.textContent = 'Nema odigranih igara za prikaz.'; 
        document.getElementById('modalWins').textContent='0'; 
        document.getElementById('modalLosses').textContent='0'; 
        document.getElementById('modalDiff').textContent='0'; 
        return; 
      }
      
      // compute stats
      let wins=0, losses=0, pf=0, pa=0;
      const table = document.createElement('table'); 
      table.style.width='100%'; 
      table.style.marginTop='8px';
      table.innerHTML = '<thead><tr><th>Date</th><th>Opponent</th><th>Score</th><th>Result</th></tr></thead>'; 
      const tbody=document.createElement('tbody');
      
      arr.forEach(g=>{ 
        const t1 = (g.team1||'').toString().toLowerCase(); 
        const t2 = (g.team2||'').toString().toLowerCase(); 
        const team1Display = g.team1Display||g.team1||t1; 
        const team2Display = g.team2Display||g.team2||t2; 
        const score1=g.score1||0; 
        const score2=g.score2||0; 
        const dateVal = g.createdAt && g.createdAt.toDate ? g.createdAt.toDate() : (g.createdAt? new Date(g.createdAt): null); 
        const dateStr = dateVal? dateVal.toLocaleString([], {dateStyle:'short', timeStyle:'short'}): '‚Äî'; 
        
        let myScore, oppScore, oppName; 
        if (t1===userKey){ 
          myScore=score1; 
          oppScore=score2; 
          oppName=team2Display; 
        } else { 
          myScore=score2; 
          oppScore=score1; 
          oppName=team1Display; 
        } 
        
        pf+=myScore; 
        pa+=oppScore; 
        
        let result=''; 
        if (myScore>oppScore){ 
          wins++; 
          result='<span style="color:var(--success);font-weight:600">W</span>'; 
        } else if (myScore<oppScore){ 
          losses++; 
          result='<span style="color:var(--error);font-weight:600">L</span>'; 
        } else {
          result='<span style="color:var(--muted)">D</span>';
        }
        
        const tr=document.createElement('tr'); 
        tr.innerHTML = `<td>${dateStr}</td><td>${oppName}</td><td>${myScore} ‚Äî ${oppScore}</td><td style="text-align:center">${result}</td>`; 
        tbody.appendChild(tr); 
      }); 
      
      table.appendChild(tbody); 
      gamesContainer.innerHTML=''; 
      gamesContainer.appendChild(table); 
      
      document.getElementById('modalWins').textContent=String(wins); 
      document.getElementById('modalLosses').textContent=String(losses); 
      document.getElementById('modalDiff').textContent=String(pf-pa); 
    }

    profileUnsub1 = gamesRef.where('team1', '==', userKey).orderBy('createdAt','desc').limit(10).onSnapshot(snap => { 
      snap.docChanges().forEach(ch=>{ 
        if (ch.type==='removed') gamesMap.delete(ch.doc.id); 
        else gamesMap.set(ch.doc.id, ch.doc.data()); 
      }); 
      renderModalGames(); 
    });
    
    profileUnsub2 = gamesRef.where('team2', '==', userKey).orderBy('createdAt','desc').limit(10).onSnapshot(snap => { 
      snap.docChanges().forEach(ch=>{ 
        if (ch.type==='removed') gamesMap.delete(ch.doc.id); 
        else gamesMap.set(ch.doc.id, ch.doc.data()); 
      }); 
      renderModalGames(); 
    });
  }

  // close modal handler
  modalClose.addEventListener('click', () => { 
    modalBackdrop.style.display = 'none'; 
    modalContent.innerHTML=''; 
    if (profileUnsub1) { profileUnsub1(); profileUnsub1=null; } 
    if (profileUnsub2) { profileUnsub2(); profileUnsub2=null; } 
  });
  
  modalBackdrop.addEventListener('click', (e)=>{ 
    if (e.target===modalBackdrop){ 
      modalClose.click(); 
    } 
  });

  // ---------- NETWORK STATUS HANDLING ----------
  window.addEventListener('online', () => {
    isOnline = true;
    console.log('Connection restored');
    offlineIndicator.style.display = 'none';
    // Reload data when back online
    if (currentUser) {
      loadReservations().then(() => renderCalendar());
    }
  });

  window.addEventListener('offline', () => {
    isOnline = false;
    console.log('Connection lost - working offline');
    offlineIndicator.style.display = 'block';
  });

  // ---------- PWA INSTALL FUNCTIONALITY ----------
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`PWA install outcome: ${outcome}`);
      deferredPrompt = null;
      installBtn.style.display = 'none';
    }
  });

  // Hide install button if app is already installed
  window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
    console.log('PWA was installed');
  });

  // Request notification permission on first load
  if (notificationPermission === 'default') {
    Notification.requestPermission().then(permission => {
      notificationPermission = permission;
      console.log('Notification permission:', permission);
    });
  }

  // ---------- SERVICE WORKER REGISTRATION ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // Register main service worker
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => {
          console.log('Service Worker registered successfully:', reg);
          
          // Check for updates every 60 seconds
          setInterval(() => {
            reg.update();
          }, 60000);
          
          // Also check on focus (when user returns to app)
          window.addEventListener('focus', () => {
            reg.update();
          });
          
          // Listen for updates
          reg.addEventListener('updatefound', () => {
            const newServiceWorker = reg.installing;
            newServiceWorker.addEventListener('statechange', () => {
              if (newServiceWorker.state === 'installed') {
                if (navigator.serviceWorker.controller) {
                  // New service worker is available
                  showUpdateNotification();
                } else {
                  // First time installation
                  console.log('Service Worker installed for the first time');
                }
              }
            });
          });
          
          // Listen for controller change (when new SW takes control)
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('New service worker is controlling the page');
            // Force reload to get the latest version
            window.location.reload();
          });
        })
        .catch(err => {
          console.error('Service Worker registration failed:', err);
          console.warn('PWA features may not work properly. Please check your internet connection.');
        });
      
      // Register Firebase messaging service worker
      navigator.serviceWorker.register('./firebase-messaging-sw.js')
        .then(reg => {
          console.log('Firebase Messaging Service Worker registered:', reg);
        })
        .catch(err => {
          console.error('Firebase Messaging Service Worker registration failed:', err);
        });
    });
  } else {
    console.warn('Service Workers not supported in this browser');
  }

  // Show update notification
  function showUpdateNotification() {
    const updateBanner = document.createElement('div');
    updateBanner.className = 'update-banner';
    updateBanner.style.display = 'flex';
    updateBanner.innerHTML = `
      <span>üîÑ Nova verzija dostupna!</span>
      <button id="updateNowBtn">A≈æuriraj Sada</button>
    `;
    document.body.appendChild(updateBanner);
    
    document.getElementById('updateNowBtn').addEventListener('click', () => {
      console.log('User clicked update button');
      // Reload to get new version
      window.location.reload();
    });
  }

  console.log('All event listeners registered. App ready!');
</script>
</body>
</html>
