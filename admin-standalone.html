<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Log Games</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1D428A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hoops Admin">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="icon" href="assets/icon-192.png">

  <style>
    :root{
      --brand:#1D428A;
      --accent:#FFC72C;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f5f7fb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    #loginWrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    #loginBox{
      width:420px;
      max-width:95%;
      background:var(--card);
      border-radius:12px;
      padding:28px;
      box-shadow:0 10px 30px rgba(20,30,60,0.08);
      text-align:center;
    }
    #loginBox h1{margin:0 0 8px;font-size:20px;color:var(--brand)}
    #loginBox p{margin:0 0 20px;color:var(--muted)}

    #googleLoginBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      background:var(--brand);
      color:var(--accent);
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:15px;
    }
    #googleLoginBtn img{width:18px;height:18px}

    #adminWrapper{
      display:none;
      max-width:900px;
      margin:20px auto;
      padding:20px;
    }

    .adminHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:20px;
    }
    .brand h2{margin:0;color:var(--brand)}
    .logoutBtn{
      background:var(--accent);
      color:var(--brand);
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }

    /* Tab navigation */
    .tab-nav{
      display:flex;
      gap:8px;
      margin-bottom:24px;
      background:var(--card);
      padding:8px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(20,30,60,0.06);
      overflow-x:auto;
    }
    .tab-btn{
      padding:12px 20px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:600;
      color:var(--muted);
      border-radius:8px;
      transition:all 0.3s ease;
      white-space:nowrap;
      flex:1;
    }
    .tab-btn.active{
      color:var(--brand);
      background:var(--bg);
      box-shadow:0 2px 8px rgba(20,30,60,0.1);
    }
    .tab-btn:hover:not(.active){
      background:var(--bg);
    }
    .tab-content{
      display:none;
    }
    .tab-content.active{
      display:block;
    }

    .formCard{
      background:var(--card);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(20,30,60,0.06);
      margin-bottom:20px;
    }
    .formCard h3{margin-top:0}
    .formRow{display:flex;flex-direction:column;gap:8px;margin-bottom:15px}
    input[type="text"], input[type="number"], select{
      padding:10px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      font-size:14px;
      width:100%;
    }
    .primaryBtn{
      background:var(--brand);
      color:var(--accent);
      border:none;
      padding:12px 20px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:16px;
    }
    .secondaryBtn{
      background:#e5e7eb;
      color:#374151;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      margin-left:8px;
    }

    .leaderboardCard{
      background:var(--card);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(20,30,60,0.06);
    }
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd;}
    th{background:var(--brand);color:var(--accent);}
    .center{text-align:center;}
    .small{font-size:13px;color:var(--muted);}
    
    /* Player input groups */
    .player-group{
      background:var(--bg);
      padding:12px;
      border-radius:8px;
      margin-bottom:12px;
    }
    .player-group-title{
      font-weight:600;
      color:var(--brand);
      margin-bottom:8px;
      font-size:14px;
    }
    .player-inputs{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    @media (max-width:768px){
      #adminWrapper{
        padding:16px;
      }
      .tab-btn{
        padding:10px 16px;
        font-size:14px;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrapper">
  <div id="loginBox">
    <h1>Admin - Log Games</h1>
    <p>Prijavite se da biste mogli logirati igre.</p>
    <button id="googleLoginBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" />
      Prijavi se s Googleom
    </button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminWrapper">
  <header class="adminHeader">
    <div class="brand">
      <h2>Hoops Admin</h2>
      <div class="small">Log Games & Leaderboard</div>
    </div>
    <div>
      <div class="small" id="userEmail">‚Äî</div>
      <button id="logoutBtn" class="logoutBtn">Odjava</button>
    </div>
  </header>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn active" data-tab="1v1">üèÄ 1v1</button>
    <button class="tab-btn" data-tab="2v2">üë• 2v2</button>
    <button class="tab-btn" data-tab="3v3">üë™ 3v3</button>
    <button class="tab-btn" data-tab="leaderboard">üèÜ Leaderboard</button>
  </div>

  <!-- 1v1 Tab -->
  <div id="1v1Tab" class="tab-content active">
    <div class="formCard">
      <h3>Log 1v1 Game</h3>
      <form id="log1v1Form">
        <div class="formRow">
          <label>Player 1</label>
          <select id="player1_1v1" required>
            <option value="">-- select player --</option>
          </select>
          <input type="text" id="player1New_1v1" placeholder="Enter new player name" style="display:none;">
        </div>

        <div class="formRow">
          <label>Score 1</label>
          <input type="number" id="score1_1v1" placeholder="Player 1 Score" required>
        </div>

        <div class="formRow">
          <label>Player 2</label>
          <select id="player2_1v1" required>
            <option value="">-- select player --</option>
          </select>
          <input type="text" id="player2New_1v1" placeholder="Enter new player name" style="display:none;">
        </div>

        <div class="formRow">
          <label>Score 2</label>
          <input type="number" id="score2_1v1" placeholder="Player 2 Score" required>
        </div>

        <button type="submit" class="primaryBtn">Log 1v1 Game</button>
      </form>
    </div>

    <div class="leaderboardCard">
      <h3>Recent 1v1 Games</h3>
      <div id="games1v1Loading" class="small">Uƒçitavanje...</div>
      <table id="games1v1Table" style="display:none;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Player 1</th>
            <th class="center">Score</th>
            <th>Player 2</th>
            <th class="center">Winner</th>
          </tr>
        </thead>
        <tbody id="games1v1Body"></tbody>
      </table>
      <div id="games1v1Empty" class="small" style="display:none">Nema odigranih 1v1 igara.</div>
    </div>
  </div>

  <!-- 2v2 Tab -->
  <div id="2v2Tab" class="tab-content">
    <div class="formCard">
      <h3>Log 2v2 Game</h3>
      <form id="log2v2Form">
        <div class="player-group">
          <div class="player-group-title">Team 1</div>
          <div class="player-inputs">
            <select id="player1_2v2" required>
              <option value="">-- select player 1 --</option>
            </select>
            <input type="text" id="player1New_2v2" placeholder="Enter new player 1 name" style="display:none;">
            
            <select id="player2_2v2" required>
              <option value="">-- select player 2 --</option>
            </select>
            <input type="text" id="player2New_2v2" placeholder="Enter new player 2 name" style="display:none;">
          </div>
        </div>

        <div class="formRow">
          <label>Team 1 Score</label>
          <input type="number" id="score1_2v2" placeholder="Team 1 Score" required>
        </div>

        <div class="player-group">
          <div class="player-group-title">Team 2</div>
          <div class="player-inputs">
            <select id="player3_2v2" required>
              <option value="">-- select player 1 --</option>
            </select>
            <input type="text" id="player3New_2v2" placeholder="Enter new player 1 name" style="display:none;">
            
            <select id="player4_2v2" required>
              <option value="">-- select player 2 --</option>
            </select>
            <input type="text" id="player4New_2v2" placeholder="Enter new player 2 name" style="display:none;">
          </div>
        </div>

        <div class="formRow">
          <label>Team 2 Score</label>
          <input type="number" id="score2_2v2" placeholder="Team 2 Score" required>
        </div>

        <button type="submit" class="primaryBtn">Log 2v2 Game</button>
      </form>
    </div>

    <div class="leaderboardCard">
      <h3>Recent 2v2 Games</h3>
      <div id="games2v2Loading" class="small">Uƒçitavanje...</div>
      <table id="games2v2Table" style="display:none;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Team 1</th>
            <th class="center">Score</th>
            <th>Team 2</th>
            <th class="center">Winner</th>
          </tr>
        </thead>
        <tbody id="games2v2Body"></tbody>
      </table>
      <div id="games2v2Empty" class="small" style="display:none">Nema odigranih 2v2 igara.</div>
    </div>
  </div>

  <!-- 3v3 Tab -->
  <div id="3v3Tab" class="tab-content">
    <div class="formCard">
      <h3>Log 3v3 Game</h3>
      <form id="log3v3Form">
        <div class="player-group">
          <div class="player-group-title">Team 1</div>
          <div class="player-inputs">
            <select id="player1_3v3" required>
              <option value="">-- select player 1 --</option>
            </select>
            <input type="text" id="player1New_3v3" placeholder="Enter new player 1 name" style="display:none;">
            
            <select id="player2_3v3" required>
              <option value="">-- select player 2 --</option>
            </select>
            <input type="text" id="player2New_3v3" placeholder="Enter new player 2 name" style="display:none;">
            
            <select id="player3_3v3" required>
              <option value="">-- select player 3 --</option>
            </select>
            <input type="text" id="player3New_3v3" placeholder="Enter new player 3 name" style="display:none;">
          </div>
        </div>

        <div class="formRow">
          <label>Team 1 Score</label>
          <input type="number" id="score1_3v3" placeholder="Team 1 Score" required>
        </div>

        <div class="player-group">
          <div class="player-group-title">Team 2</div>
          <div class="player-inputs">
            <select id="player4_3v3" required>
              <option value="">-- select player 1 --</option>
            </select>
            <input type="text" id="player4New_3v3" placeholder="Enter new player 1 name" style="display:none;">
            
            <select id="player5_3v3" required>
              <option value="">-- select player 2 --</option>
            </select>
            <input type="text" id="player5New_3v3" placeholder="Enter new player 2 name" style="display:none;">
            
            <select id="player6_3v3" required>
              <option value="">-- select player 3 --</option>
            </select>
            <input type="text" id="player6New_3v3" placeholder="Enter new player 3 name" style="display:none;">
          </div>
        </div>

        <div class="formRow">
          <label>Team 2 Score</label>
          <input type="number" id="score2_3v3" placeholder="Team 2 Score" required>
        </div>

        <button type="submit" class="primaryBtn">Log 3v3 Game</button>
      </form>
    </div>

    <div class="leaderboardCard">
      <h3>Recent 3v3 Games</h3>
      <div id="games3v3Loading" class="small">Uƒçitavanje...</div>
      <table id="games3v3Table" style="display:none;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Team 1</th>
            <th class="center">Score</th>
            <th>Team 2</th>
            <th class="center">Winner</th>
          </tr>
        </thead>
        <tbody id="games3v3Body"></tbody>
      </table>
      <div id="games3v3Empty" class="small" style="display:none">Nema odigranih 3v3 igara.</div>
    </div>
  </div>

  <!-- Leaderboard Tab -->
  <div id="leaderboardTab" class="tab-content">
    <div class="leaderboardCard">
      <h3>Leaderboard (1v1 Only)</h3>
      <div id="leaderboardLoading" class="small">Uƒçitavanje...</div>
      <table id="leaderboardTable" style="display:none;">
        <thead>
          <tr>
            <th>Name</th>
            <th class="center">Wins</th>
            <th class="center">Losses</th>
            <th class="center">Point Diff</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
      <div id="leaderboardEmpty" class="small" style="display:none">Nema odigranih igara za prikaz.</div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { 
    getFirestore, collection, getDocs, doc, addDoc
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginWrapper = document.getElementById("loginWrapper");
  const adminWrapper = document.getElementById("adminWrapper");
  const loginBtn = document.getElementById("googleLoginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmail = document.getElementById("userEmail");

  // Forms
  const log1v1Form = document.getElementById("log1v1Form");
  const log2v2Form = document.getElementById("log2v2Form");
  const log3v3Form = document.getElementById("log3v3Form");

  // Game tables
  const games1v1Loading = document.getElementById("games1v1Loading");
  const games1v1Table = document.getElementById("games1v1Table");
  const games1v1Body = document.getElementById("games1v1Body");
  const games1v1Empty = document.getElementById("games1v1Empty");

  const games2v2Loading = document.getElementById("games2v2Loading");
  const games2v2Table = document.getElementById("games2v2Table");
  const games2v2Body = document.getElementById("games2v2Body");
  const games2v2Empty = document.getElementById("games2v2Empty");

  const games3v3Loading = document.getElementById("games3v3Loading");
  const games3v3Table = document.getElementById("games3v3Table");
  const games3v3Body = document.getElementById("games3v3Body");
  const games3v3Empty = document.getElementById("games3v3Empty");

  const leaderboardLoading = document.getElementById("leaderboardLoading");
  const leaderboardTable = document.getElementById("leaderboardTable");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const leaderboardEmpty = document.getElementById("leaderboardEmpty");

  let usersCache = {};
  let currentUser = null;

  function slugify(s) {
    return (s || '').toString().trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g,'');
  }

  // Google login
  loginBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (error) {
      console.error("Login error:", error);
      alert("Do≈°lo je do pogre≈°ke pri prijavi.");
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      loginWrapper.style.display = "flex";
      adminWrapper.style.display = "none";
      return;
    }

    // Check if user is admin
    if (user.email === "linovernik@gmail.com") {
      currentUser = user;
      loginWrapper.style.display = "none";
      adminWrapper.style.display = "block";
      userEmail.textContent = user.email;

      // Load admin data
      loadUsersForSelects().catch(err => console.error("Load users error", err));
      load1v1Games().catch(err => console.error("Load 1v1 games error", err));
    } else {
      alert("Nemate pristup admin stranici.");
      signOut(auth).catch(err => console.error("Sign out error", err));
    }
  });

  // Tab navigation
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      btn.classList.add('active');
      const tabId = btn.dataset.tab + 'Tab';
      document.getElementById(tabId).classList.add('active');
      
      // Load data for specific tab
      if (btn.dataset.tab === '1v1') {
        load1v1Games();
      } else if (btn.dataset.tab === '2v2') {
        load2v2Games();
      } else if (btn.dataset.tab === '3v3') {
        load3v3Games();
      } else if (btn.dataset.tab === 'leaderboard') {
        loadLeaderboard();
      }
    });
  });

  // Load users into dropdowns
  async function loadUsersForSelects() {
    usersCache = {};
    
    const usersSnap = await getDocs(collection(db, "users"));
    
    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "-- select player --";

    const otherOpt = document.createElement("option");
    otherOpt.value = "__new__";
    otherOpt.textContent = "Other / New...";

    // Populate all select elements
    const selects = [
      'player1_1v1', 'player2_1v1',
      'player1_2v2', 'player2_2v2', 'player3_2v2', 'player4_2v2',
      'player1_3v3', 'player2_3v3', 'player3_3v3', 'player4_3v3', 'player5_3v3', 'player6_3v3'
    ];

    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      select.innerHTML = "";
      select.appendChild(defaultOpt.cloneNode(true));
    });

    usersSnap.forEach(docSnap => {
      const u = docSnap.data();
      const key = u.key || slugify(u.name || '');
      const label = u.displayName || u.name || key;
      usersCache[key] = { id: docSnap.id, key, label, ...u };

      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = label;
        select.appendChild(opt);
      });
    });

    // Add "Other / New..." option to all selects
    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      select.appendChild(otherOpt.cloneNode(true));
    });

    // Setup change listeners for showing/hiding new input fields
    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      const newInput = document.getElementById(selectId.replace(/_\dv\d/, 'New_' + selectId.split('_')[1]));
      if (newInput) {
        select.addEventListener("change", () => {
          newInput.style.display = select.value === "__new__" ? "block" : "none";
        });
      }
    });
  }

  // Helper function to get player name/key
  function getPlayerData(selectId, newInputId) {
    const select = document.getElementById(selectId);
    const newInput = document.getElementById(newInputId);
    
    if (select.value === "__new__") {
      const displayName = newInput.value.trim();
      if (!displayName) return null;
      const key = slugify(displayName);
      return { key, displayName };
    } else if (select.value) {
      const key = select.value;
      const displayName = usersCache[key] ? usersCache[key].label : key;
      return { key, displayName };
    }
    return null;
  }

  // ---------- 1V1 GAME LOGGING ----------
  log1v1Form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const player1 = getPlayerData('player1_1v1', 'player1New_1v1');
    const player2 = getPlayerData('player2_1v1', 'player2New_1v1');

    if (!player1) { alert("Enter Player 1"); return; }
    if (!player2) { alert("Enter Player 2"); return; }

    const score1 = parseInt(document.getElementById("score1_1v1").value);
    const score2 = parseInt(document.getElementById("score2_1v1").value);

    if (isNaN(score1) || isNaN(score2)) { alert("Enter valid scores"); return; }
    if (player1.key === player2.key) { alert("Players must be different"); return; }

    try {
      await addDoc(collection(db,"games_1v1"),{
        team1: player1.key,
        team1Display: player1.displayName,
        score1,
        team2: player2.key,
        team2Display: player2.displayName,
        score2,
        winner: score1 > score2 ? player1.key : player2.key,
        createdAt: new Date()
      });

      alert("1v1 Game logged successfully!");
      log1v1Form.reset();
      document.getElementById('player1New_1v1').style.display = 'none';
      document.getElementById('player2New_1v1').style.display = 'none';

      await loadUsersForSelects();
      await load1v1Games();
    } catch (error) {
      console.error("Error logging 1v1 game:", error);
      alert("Error logging game. Please try again.");
    }
  });

  async function load1v1Games() {
    games1v1Loading.style.display = '';
    games1v1Table.style.display = 'none';
    games1v1Empty.style.display = 'none';
    games1v1Body.innerHTML = '';

    try {
      const gamesSnap = await getDocs(collection(db, 'games_1v1'));
      
      if (gamesSnap.empty) {
        games1v1Loading.style.display = 'none';
      games1v1Table.style.display = '';
    } catch (error) {
      console.error('Error loading 1v1 games:', error);
      games1v1Loading.style.display = 'none';
      games1v1Empty.style.display = '';
    }
  }

  // ---------- 2V2 GAME LOGGING ----------
  log2v2Form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const player1 = getPlayerData('player1_2v2', 'player1New_2v2');
    const player2 = getPlayerData('player2_2v2', 'player2New_2v2');
    const player3 = getPlayerData('player3_2v2', 'player3New_2v2');
    const player4 = getPlayerData('player4_2v2', 'player4New_2v2');

    if (!player1 || !player2 || !player3 || !player4) {
      alert("Please select or enter all 4 players");
      return;
    }

    const score1 = parseInt(document.getElementById("score1_2v2").value);
    const score2 = parseInt(document.getElementById("score2_2v2").value);

    if (isNaN(score1) || isNaN(score2)) { alert("Enter valid scores"); return; }

    // Check for duplicate players
    const playerKeys = [player1.key, player2.key, player3.key, player4.key];
    const uniqueKeys = new Set(playerKeys);
    if (uniqueKeys.size !== 4) {
      alert("All players must be different");
      return;
    }

    try {
      const team1Display = `${player1.displayName} & ${player2.displayName}`;
      const team2Display = `${player3.displayName} & ${player4.displayName}`;

      await addDoc(collection(db,"games_2v2"),{
        team1Players: [player1.key, player2.key],
        team1Display,
        score1,
        team2Players: [player3.key, player4.key],
        team2Display,
        score2,
        winner: score1 > score2 ? 'team1' : 'team2',
        createdAt: new Date()
      });

      alert("2v2 Game logged successfully!");
      log2v2Form.reset();
      ['player1New_2v2', 'player2New_2v2', 'player3New_2v2', 'player4New_2v2'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });

      await loadUsersForSelects();
      await load2v2Games();
    } catch (error) {
      console.error("Error logging 2v2 game:", error);
      alert("Error logging game. Please try again.");
    }
  });

  async function load2v2Games() {
    games2v2Loading.style.display = '';
    games2v2Table.style.display = 'none';
    games2v2Empty.style.display = 'none';
    games2v2Body.innerHTML = '';

    try {
      const gamesSnap = await getDocs(collection(db, 'games_2v2'));
      
      if (gamesSnap.empty) {
        games2v2Loading.style.display = 'none';
        games2v2Empty.style.display = '';
        return;
      }

      const games = [];
      gamesSnap.forEach(doc => {
        games.push({ id: doc.id, ...doc.data() });
      });

      games.sort((a, b) => {
        const dateA = a.createdAt?.seconds || 0;
        const dateB = b.createdAt?.seconds || 0;
        return dateB - dateA;
      });

      games.slice(0, 20).forEach(game => {
        const tr = document.createElement("tr");
        const date = game.createdAt ? new Date(game.createdAt.seconds * 1000).toLocaleString('hr-HR') : '‚Äî';
        
        let winnerText = '‚Äî';
        if ((game.score1 || 0) > (game.score2 || 0)) {
          winnerText = game.team1Display || 'Team 1';
        } else if ((game.score2 || 0) > (game.score1 || 0)) {
          winnerText = game.team2Display || 'Team 2';
        }

        tr.innerHTML = `
          <td>${date}</td>
          <td>${game.team1Display || 'Team 1'}</td>
          <td class="center"><strong>${game.score1 || 0} - ${game.score2 || 0}</strong></td>
          <td>${game.team2Display || 'Team 2'}</td>
          <td class="center">${winnerText}</td>
        `;
        games2v2Body.appendChild(tr);
      });

      games2v2Loading.style.display = 'none';
      games2v2Table.style.display = '';
    } catch (error) {
      console.error('Error loading 2v2 games:', error);
      games2v2Loading.style.display = 'none';
      games2v2Empty.style.display = '';
    }
  }

  // ---------- 3V3 GAME LOGGING ----------
  log3v3Form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const player1 = getPlayerData('player1_3v3', 'player1New_3v3');
    const player2 = getPlayerData('player2_3v3', 'player2New_3v3');
    const player3 = getPlayerData('player3_3v3', 'player3New_3v3');
    const player4 = getPlayerData('player4_3v3', 'player4New_3v3');
    const player5 = getPlayerData('player5_3v3', 'player5New_3v3');
    const player6 = getPlayerData('player6_3v3', 'player6New_3v3');

    if (!player1 || !player2 || !player3 || !player4 || !player5 || !player6) {
      alert("Please select or enter all 6 players");
      return;
    }

    const score1 = parseInt(document.getElementById("score1_3v3").value);
    const score2 = parseInt(document.getElementById("score2_3v3").value);

    if (isNaN(score1) || isNaN(score2)) { alert("Enter valid scores"); return; }

    // Check for duplicate players
    const playerKeys = [player1.key, player2.key, player3.key, player4.key, player5.key, player6.key];
    const uniqueKeys = new Set(playerKeys);
    if (uniqueKeys.size !== 6) {
      alert("All players must be different");
      return;
    }

    try {
      const team1Display = `${player1.displayName}, ${player2.displayName} & ${player3.displayName}`;
      const team2Display = `${player4.displayName}, ${player5.displayName} & ${player6.displayName}`;

      await addDoc(collection(db,"games_3v3"),{
        team1Players: [player1.key, player2.key, player3.key],
        team1Display,
        score1,
        team2Players: [player4.key, player5.key, player6.key],
        team2Display,
        score2,
        winner: score1 > score2 ? 'team1' : 'team2',
        createdAt: new Date()
      });

      alert("3v3 Game logged successfully!");
      log3v3Form.reset();
      ['player1New_3v3', 'player2New_3v3', 'player3New_3v3', 'player4New_3v3', 'player5New_3v3', 'player6New_3v3'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });

      await loadUsersForSelects();
      await load3v3Games();
    } catch (error) {
      console.error("Error logging 3v3 game:", error);
      alert("Error logging game. Please try again.");
    }
  });

  async function load3v3Games() {
    games3v3Loading.style.display = '';
    games3v3Table.style.display = 'none';
    games3v3Empty.style.display = 'none';
    games3v3Body.innerHTML = '';

    try {
      const gamesSnap = await getDocs(collection(db, 'games_3v3'));
      
      if (gamesSnap.empty) {
        games3v3Loading.style.display = 'none';
        games3v3Empty.style.display = '';
        return;
      }

      const games = [];
      gamesSnap.forEach(doc => {
        games.push({ id: doc.id, ...doc.data() });
      });

      games.sort((a, b) => {
        const dateA = a.createdAt?.seconds || 0;
        const dateB = b.createdAt?.seconds || 0;
        return dateB - dateA;
      });

      games.slice(0, 20).forEach(game => {
        const tr = document.createElement("tr");
        const date = game.createdAt ? new Date(game.createdAt.seconds * 1000).toLocaleString('hr-HR') : '‚Äî';
        
        let winnerText = '‚Äî';
        if ((game.score1 || 0) > (game.score2 || 0)) {
          winnerText = game.team1Display || 'Team 1';
        } else if ((game.score2 || 0) > (game.score1 || 0)) {
          winnerText = game.team2Display || 'Team 2';
        }

        tr.innerHTML = `
          <td>${date}</td>
          <td>${game.team1Display || 'Team 1'}</td>
          <td class="center"><strong>${game.score1 || 0} - ${game.score2 || 0}</strong></td>
          <td>${game.team2Display || 'Team 2'}</td>
          <td class="center">${winnerText}</td>
        `;
        games3v3Body.appendChild(tr);
      });

      games3v3Loading.style.display = 'none';
      games3v3Table.style.display = '';
    } catch (error) {
      console.error('Error loading 3v3 games:', error);
      games3v3Loading.style.display = 'none';
      games3v3Empty.style.display = '';
    }
  }

  // ---------- LEADERBOARD ----------
  async function loadLeaderboard() {
    leaderboardLoading.style.display = '';
    leaderboardTable.style.display = 'none';
    leaderboardEmpty.style.display = 'none';
    leaderboardBody.innerHTML = '';

    try {
      const usersMap = {};

      const gamesSnap = await getDocs(collection(db, 'games_1v1'));
      let gameCount = 0;
      
      gamesSnap.forEach(docSnap => {
        const g = docSnap.data();
        const t1Key = (g.team1 || g.team1Key || '').toString().toLowerCase();
        const t2Key = (g.team2 || g.team2Key || '').toString().toLowerCase();
        
        if (!t1Key || !t2Key) return;
        gameCount++;
        
        if (!usersMap[t1Key]) {
          usersMap[t1Key] = { 
            key: t1Key, 
            name: g.team1Display || t1Key, 
            wins: 0, 
            losses: 0, 
            pointsFor: 0, 
            pointsAgainst: 0 
          };
        }
        if (!usersMap[t2Key]) {
          usersMap[t2Key] = { 
            key: t2Key, 
            name: g.team2Display || t2Key, 
            wins: 0, 
            losses: 0, 
            pointsFor: 0, 
            pointsAgainst: 0 
          };
        }
        
        usersMap[t1Key].pointsFor += (g.score1 || 0);
        usersMap[t1Key].pointsAgainst += (g.score2 || 0);
        usersMap[t2Key].pointsFor += (g.score2 || 0);
        usersMap[t2Key].pointsAgainst += (g.score1 || 0);
        
        if ((g.score1 || 0) > (g.score2 || 0)) { 
          usersMap[t1Key].wins += 1; 
          usersMap[t2Key].losses += 1; 
        } else if ((g.score2 || 0) > (g.score1 || 0)) { 
          usersMap[t2Key].wins += 1; 
          usersMap[t1Key].losses += 1; 
        }
      });

      leaderboardLoading.style.display = 'none';
      
      if (gameCount === 0) {
        leaderboardEmpty.style.display = '';
        leaderboardEmpty.textContent = 'Nema odigranih igara za prikaz.';
        return;
      }
      
      const leaderboardArray = Object.values(usersMap);
      leaderboardArray.sort((a,b)=>{
        if (b.wins !== a.wins) return b.wins - a.wins;
        return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
      });

      leaderboardArray.forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:6px;">${u.name}</td>
          <td style="padding:6px; text-align:center;">${u.wins}</td>
          <td style="padding:6px; text-align:center;">${u.losses}</td>
          <td style="padding:6px; text-align:center;">${u.pointsFor - u.pointsAgainst}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      leaderboardTable.style.display = '';
    } catch (error) {
      console.error('Error loading leaderboard:', error);
      leaderboardLoading.style.display = 'none';
      leaderboardEmpty.style.display = '';
      leaderboardEmpty.textContent = 'Gre≈°ka pri uƒçitavanju leaderboarda.';
    }
  }

  // Service Worker registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg))
        .catch(err => console.log('Service Worker registration failed:', err));
    });
  }
</script>
</body>
</html>
        games1v1Empty.style.display = '';
        return;
      }

      const games = [];
      gamesSnap.forEach(doc => {
        games.push({ id: doc.id, ...doc.data() });
      });

      games.sort((a, b) => {
        const dateA = a.createdAt?.seconds || 0;
        const dateB = b.createdAt?.seconds || 0;
        return dateB - dateA;
      });

      games.slice(0, 20).forEach(game => {
        const tr = document.createElement("tr");
        const date = game.createdAt ? new Date(game.createdAt.seconds * 1000).toLocaleString('hr-HR') : '‚Äî';
        
        let winnerText = '‚Äî';
        if ((game.score1 || 0) > (game.score2 || 0)) {
          winnerText = game.team1Display || game.team1;
        } else if ((game.score2 || 0) > (game.score1 || 0)) {
          winnerText = game.team2Display || game.team2;
        }

        tr.innerHTML = `
          <td>${date}</td>
          <td>${game.team1Display || game.team1}</td>
          <td class="center"><strong>${game.score1 || 0} - ${game.score2 || 0}</strong></td>
          <td>${game.team2Display || game.team2}</td>
          <td class="center">${winnerText}</td>
        `;
        games1v1Body.appendChild(tr);
      });

      games1v1Loading.style.display = 'none';
