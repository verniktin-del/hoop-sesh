<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Log Games</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1D428A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hoops Admin">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="icon" href="assets/icon-192.png">

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --brand:#1D428A;
      --accent:#FFC72C;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f5f7fb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    #loginWrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    #loginBox{
      width:420px;
      max-width:95%;
      background:var(--card);
      border-radius:12px;
      padding:28px;
      box-shadow:0 10px 30px rgba(20,30,60,0.08);
      text-align:center;
    }
    #loginBox h1{margin:0 0 8px;font-size:20px;color:var(--brand)}
    #loginBox p{margin:0 0 20px;color:var(--muted)}

    #googleLoginBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      background:var(--brand);
      color:var(--accent);
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:15px;
    }
    #googleLoginBtn img{width:18px;height:18px}

    #adminWrapper{
      display:none;
      max-width:800px;
      margin:20px auto;
      padding:20px;
    }

    .adminHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:20px;
    }
    .brand h2{margin:0;color:var(--brand)}
    .logoutBtn{
      background:var(--accent);
      color:var(--brand);
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }

    .formCard{
      background:var(--card);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(20,30,60,0.06);
      margin-bottom:20px;
    }
    .formCard h3{margin-top:0}
    .formRow{display:flex;flex-direction:column;gap:8px;margin-bottom:15px}
    input[type="text"], input[type="number"], select{
      padding:10px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      font-size:14px;
      width:100%;
    }
    .primaryBtn{
      background:var(--brand);
      color:var(--accent);
      border:none;
      padding:12px 20px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:16px;
    }

    .leaderboardCard{
      background:var(--card);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(20,30,60,0.06);
    }
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd;}
    th{background:var(--brand);color:var(--accent);}
    .center{text-align:center;}
    .small{font-size:13px;color:var(--muted);}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrapper">
  <div id="loginBox">
    <h1>Admin - Log Games</h1>
    <p>Prijavite se da biste mogli logirati igre.</p>
    <button id="googleLoginBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" />
      Prijavi se s Googleom
    </button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminWrapper">
  <header class="adminHeader">
    <div class="brand">
      <h2>Hoops Admin</h2>
      <div class="small">Log Games & Leaderboard</div>
    </div>
    <div>
      <div class="small" id="userEmail">—</div>
      <button id="logoutBtn" class="logoutBtn">Odjava</button>
    </div>
  </header>

  <!-- Log Game Form -->
  <div class="formCard">
    <h3>Log Game</h3>
    <form id="logGameForm">
      <div class="formRow">
        <label>Player 1</label>
        <select id="team1Select" required>
          <option value="">-- select player --</option>
        </select>
        <input type="text" id="team1NewInput" placeholder="Enter new player name" style="display:none;">
      </div>

      <div class="formRow">
        <label>Score 1</label>
        <input type="number" id="score1" placeholder="Team 1 Score" required>
      </div>

      <div class="formRow">
        <label>Player 2</label>
        <select id="team2Select" required>
          <option value="">-- select player --</option>
        </select>
        <input type="text" id="team2NewInput" placeholder="Enter new player name" style="display:none;">
      </div>

      <div class="formRow">
        <label>Score 2</label>
        <input type="number" id="score2" placeholder="Team 2 Score" required>
      </div>

      <button type="submit" class="primaryBtn">Log Game</button>
    </form>
  </div>

  <!-- Leaderboard -->
  <div class="leaderboardCard">
    <h3>Leaderboard</h3>
    <div id="leaderboardLoading" class="small">Učitavanje...</div>
    <table id="leaderboardTable" style="display:none;">
      <thead>
        <tr>
          <th>Name</th>
          <th class="center">Wins</th>
          <th class="center">Losses</th>
          <th class="center">Point Diff</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <div id="leaderboardEmpty" class="small" style="display:none">Nema odigranih igara za prikaz.</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { 
    getFirestore, collection, getDocs, updateDoc, doc, addDoc, getDoc 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  (function(){ emailjs.init("bHkaG3QCQ98fZq5Mu"); })();

  const loginWrapper = document.getElementById("loginWrapper");
  const adminWrapper = document.getElementById("adminWrapper");
  const loginBtn = document.getElementById("googleLoginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmail = document.getElementById("userEmail");
  const logGameForm = document.getElementById("logGameForm");
  const team1Select = document.getElementById("team1Select");
  const team2Select = document.getElementById("team2Select");
  const team1NewInput = document.getElementById("team1NewInput");
  const team2NewInput = document.getElementById("team2NewInput");
  const leaderboardLoading = document.getElementById("leaderboardLoading");
  const leaderboardTable = document.getElementById("leaderboardTable");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const leaderboardEmpty = document.getElementById("leaderboardEmpty");

  let usersCache = {};
  let currentUser = null;

  function slugify(s) {
    return (s || '').toString().trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g,'');
  }

  // Google login
  loginBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (error) {
      console.error("Login error:", error);
      alert("Došlo je do pogreške pri prijavi.");
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      loginWrapper.style.display = "flex";
      adminWrapper.style.display = "none";
      return;
    }

    // Check if user is admin
    if (user.email === "linovernik@gmail.com") {
      currentUser = user;
      loginWrapper.style.display = "none";
      adminWrapper.style.display = "block";
      userEmail.textContent = user.email;

      // Load admin data
      loadUsersForSelects().catch(err => console.error("Load users error", err));
      loadLeaderboard().catch(err => console.error("Load leaderboard error", err));
    } else {
      alert("Nemate pristup admin stranici.");
      signOut(auth).catch(err => console.error("Sign out error", err));
    }
  });

  // Load users into dropdowns
  async function loadUsersForSelects() {
    usersCache = {};
    team1Select.innerHTML = "";
    team2Select.innerHTML = "";

    const usersSnap = await getDocs(collection(db, "users"));
    
    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "-- select player --";
    team1Select.appendChild(defaultOpt.cloneNode(true));
    team2Select.appendChild(defaultOpt.cloneNode(true));

    usersSnap.forEach(docSnap => {
      const u = docSnap.data();
      const key = u.key || slugify(u.name || '');
      const label = u.displayName || u.name || key;
      usersCache[key] = { id: docSnap.id, key, label, ...u };

      const opt1 = document.createElement("option");
      opt1.value = key;
      opt1.textContent = label;
      team1Select.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = key;
      opt2.textContent = label;
      team2Select.appendChild(opt2);
    });

    // Add "Other / New..." option
    const other1 = document.createElement("option");
    other1.value = "__new__";
    other1.textContent = "Other / New...";
    team1Select.appendChild(other1);
    const other2 = other1.cloneNode(true);
    team2Select.appendChild(other2);

    // Show/hide new input fields
    team1Select.addEventListener("change", () => {
      team1NewInput.style.display = team1Select.value === "__new__" ? "block" : "none";
    });
    team2Select.addEventListener("change", () => {
      team2NewInput.style.display = team2Select.value === "__new__" ? "block" : "none";
    });
  }

  // Log Game Form Submit
  logGameForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    let team1Key = "";
    let team1Display = "";
    if (team1Select.value === "__new__") {
      team1Display = team1NewInput.value.trim();
      if (!team1Display) { alert("Enter a name for Player 1"); return; }
      team1Key = slugify(team1Display);
    } else if (team1Select.value) {
      team1Key = team1Select.value;
      team1Display = usersCache[team1Key] ? usersCache[team1Key].label : team1Key;
    } else {
      alert("Select Player 1"); return;
    }

    let team2Key = "";
    let team2Display = "";
    if (team2Select.value === "__new__") {
      team2Display = team2NewInput.value.trim();
      if (!team2Display) { alert("Enter a name for Player 2"); return; }
      team2Key = slugify(team2Display);
    } else if (team2Select.value) {
      team2Key = team2Select.value;
      team2Display = usersCache[team2Key] ? usersCache[team2Key].label : team2Key;
    } else {
      alert("Select Player 2"); return;
    }

    const score1 = parseInt(document.getElementById("score1").value);
    const score2 = parseInt(document.getElementById("score2").value);
    if (isNaN(score1) || isNaN(score2)) { alert("Enter valid scores"); return; }
    if (team1Key === team2Key) { alert("Players must be different"); return; }

    try {
      // Save game
      await addDoc(collection(db,"games"),{
        team1: team1Key,
        team1Display,
        score1,
        team2: team2Key,
        team2Display,
        score2,
        winner: score1 > score2 ? team1Key : team2Key,
        createdAt: new Date()
      });

      // Update user stats
      await updateUsersAfterGame(team1Key, score1, team1Display, team2Key, score2, team2Display);

      alert("Game logged successfully!");
      logGameForm.reset();
      team1NewInput.style.display = "none";
      team2NewInput.style.display = "none";

      // Refresh data
      await loadUsersForSelects();
      await loadLeaderboard();
    } catch (error) {
      console.error("Error logging game:", error);
      alert("Error logging game. Please try again.");
    }
  });

  async function updateUsersAfterGame(team1Key, score1, team1Display, team2Key, score2, team2Display) {
    // Don't update user stats in the users collection anymore
    // The leaderboard will calculate stats from games only
    // This prevents double-counting and admin duplication
    console.log('Game logged successfully. Stats will be calculated from games collection.');
  }

  async function loadLeaderboard() {
    leaderboardLoading.style.display = '';
    leaderboardTable.style.display = 'none';
    leaderboardEmpty.style.display = 'none';
    leaderboardBody.innerHTML = '';

    try {
      // Start with fresh users map - don't pre-populate from users collection
      const usersMap = {};

      // Calculate stats from games only
      const gamesSnap = await getDocs(collection(db, 'games'));
      let gameCount = 0;
      
      gamesSnap.forEach(docSnap => {
        const g = docSnap.data();
        const t1Key = (g.team1 || g.team1Key || '').toString().toLowerCase();
        const t2Key = (g.team2 || g.team2Key || '').toString().toLowerCase();
        
        if (!t1Key || !t2Key) return;
        gameCount++;
        
        // Initialize players if they don't exist
        if (!usersMap[t1Key]) {
          usersMap[t1Key] = { 
            key: t1Key, 
            name: g.team1Display || t1Key, 
            wins: 0, 
            losses: 0, 
            pointsFor: 0, 
            pointsAgainst: 0 
          };
        }
        if (!usersMap[t2Key]) {
          usersMap[t2Key] = { 
            key: t2Key, 
            name: g.team2Display || t2Key, 
            wins: 0, 
            losses: 0, 
            pointsFor: 0, 
            pointsAgainst: 0 
          };
        }
        
        // Add points from this game
        usersMap[t1Key].pointsFor += (g.score1 || 0);
        usersMap[t1Key].pointsAgainst += (g.score2 || 0);
        usersMap[t2Key].pointsFor += (g.score2 || 0);
        usersMap[t2Key].pointsAgainst += (g.score1 || 0);
        
        // Add wins/losses
        if ((g.score1 || 0) > (g.score2 || 0)) { 
          usersMap[t1Key].wins += 1; 
          usersMap[t2Key].losses += 1; 
        } else if ((g.score2 || 0) > (g.score1 || 0)) { 
          usersMap[t2Key].wins += 1; 
          usersMap[t1Key].losses += 1; 
        }
      });

      leaderboardLoading.style.display = 'none';
      
      if (gameCount === 0) {
        leaderboardEmpty.style.display = '';
        leaderboardEmpty.textContent = 'Nema odigranih igara za prikaz.';
        return;
      }
      
      const leaderboardArray = Object.values(usersMap);
      leaderboardArray.sort((a,b)=>{
        if (b.wins !== a.wins) return b.wins - a.wins;
        return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
      });

      leaderboardArray.forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:6px;">${u.name}</td>
          <td style="padding:6px; text-align:center;">${u.wins}</td>
          <td style="padding:6px; text-align:center;">${u.losses}</td>
          <td style="padding:6px; text-align:center;">${u.pointsFor - u.pointsAgainst}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      leaderboardTable.style.display = '';
    } catch (error) {
      console.error('Error loading leaderboard:', error);
      leaderboardLoading.style.display = 'none';
      leaderboardEmpty.style.display = '';
      leaderboardEmpty.textContent = 'Greška pri učitavanju leaderboarda.';
    }
  }

  // Service Worker registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg))
        .catch(err => console.log('Service Worker registration failed:', err));
    });
  }
</script>
</body>
</html>
